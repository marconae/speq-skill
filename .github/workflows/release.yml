name: Release

on:
  push:
    tags:
      - 'v[0-9]+.*'

permissions:
  contents: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}

  build:
    name: Build ${{ matrix.short }}
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            short: x86_64-linux
            os: ubuntu-latest
            cross: false
          - target: aarch64-unknown-linux-gnu
            short: aarch64-linux
            os: ubuntu-latest
            cross: true
          - target: x86_64-apple-darwin
            short: x86_64-mac
            os: macos-13
            cross: false
          - target: aarch64-apple-darwin
            short: aarch64-mac
            os: macos-14
            cross: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (Linux aarch64)
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Install cargo-about
        run: cargo install cargo-about

      - name: Build binary
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi

      - name: Generate third-party licenses
        run: cargo about generate about.hbs > THIRD_PARTY_LICENSES

      - name: Package release
        run: |
          ARCHIVE_NAME="speq-${{ github.ref_name }}-${{ matrix.short }}"
          mkdir -p "dist/${ARCHIVE_NAME}"
          cp "target/${{ matrix.target }}/release/speq" "dist/${ARCHIVE_NAME}/"
          cp LICENSE "dist/${ARCHIVE_NAME}/"
          cp THIRD_PARTY_LICENSES "dist/${ARCHIVE_NAME}/"
          tar -czvf "dist/${ARCHIVE_NAME}.tar.gz" -C dist "${ARCHIVE_NAME}"

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: dist/speq-${{ github.ref_name }}-${{ matrix.short }}.tar.gz
          asset_name: speq-${{ github.ref_name }}-${{ matrix.short }}.tar.gz
          asset_content_type: application/gzip

  build-plugin:
    name: Build Plugin
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build plugin
        run: ./scripts/plugin/build.sh

      - name: Package plugin
        run: |
          PLUGIN_ARCHIVE="speq-plugin-${{ github.ref_name }}"
          mkdir -p "dist/${PLUGIN_ARCHIVE}"
          # Copy all files including hidden directories (.claude-plugin)
          cp -r plugin/. "dist/${PLUGIN_ARCHIVE}/"
          tar -czvf "dist/${PLUGIN_ARCHIVE}.tar.gz" -C dist "${PLUGIN_ARCHIVE}"

      - name: Upload Plugin Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create-release.outputs.upload_url }}
          asset_path: dist/speq-plugin-${{ github.ref_name }}.tar.gz
          asset_name: speq-plugin-${{ github.ref_name }}.tar.gz
          asset_content_type: application/gzip
